# 1. Configuration
$Region = "us-east-1"  # <--- CHANGE THIS to your region
Set-DefaultAWSRegion -Region $Region

$endTime = Get-Date
$startTime = $endTime.AddMinutes(-60)

# 2. Fetch Instances
$reservations = Get-EC2Instance
if (-not $reservations) { Write-Error "No instances found in $Region"; return }

$report = foreach ($res in $reservations) {
    foreach ($ins in $res.Instances) {
        $instanceId = $ins.InstanceId
        $instanceName = ($ins.Tags | Where-Object { $_.Key -eq "Name" }).Value ?? "Unnamed Instance"

        # --- Fetch Memory Utilization (Last 1 Hour) ---
        $memStats = Get-CWMetricStatistic -Namespace "CWAgent" `
            -MetricName "mem_used_percent" `
            -Dimension @{Name="InstanceId"; Value=$instanceId} `
            -StartTime $startTime -EndTime $endTime -Period 3600 -Statistics Average | 
            Select-Object -ExpandProperty Datapoints | Sort-Object Timestamp -Descending | Select-Object -First 1
        $memValue = if ($memStats) { "{0:N2}%" -f $memStats.Average } else { "No Agent" }

        # --- Loop through each attached volume ---
        foreach ($blk in $ins.BlockDeviceMappings) {
            $volId = $blk.Ebs.VolumeId
            $vol = Get-EC2Volume -VolumeId $volId
            
            # Get Volume Name (from Volume Tags)
            $volName = ($vol.Tags | Where-Object { $_.Key -eq "Name" }).Value ?? "Unnamed Volume"

            # Fetch Disk Utilization for THIS specific volume
            $diskStats = Get-CWMetricStatistic -Namespace "CWAgent" `
                -MetricName "disk_used_percent" `
                -Dimension @{Name="InstanceId"; Value=$instanceId}, @{Name="device"; Value=$blk.DeviceName} `
                -StartTime $startTime -EndTime $endTime -Period 3600 -Statistics Average | 
                Select-Object -ExpandProperty Datapoints | Sort-Object Timestamp -Descending | Select-Object -First 1
            $diskValue = if ($diskStats) { "{0:N2}%" -f $diskStats.Average } else { "No Agent" }

            # Create the data object
            [PSCustomObject]@{
                Instance_Name = $instanceName
                Instance_ID   = $instanceId
                Vol_ID        = $volId
                Vol_Name      = $volName
                Memory_Util   = $memValue
                Disk_Util     = $diskValue
                Size_GB       = $vol.Size
                Type          = $vol.VolumeType
                State         = $vol.State
                IsRoot        = ($ins.RootDeviceName -eq $blk.DeviceName)
            }
        }
    }
}

# 3. Output to Screen
$report | Format-Table -AutoSize
