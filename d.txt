# Mandatory fix for Clock Skew
[Amazon.AWSConfigs]::CorrectForClockSkew = $true

# Set your region
$Region = "us-east-1"
Set-DefaultAWSRegion -Region $Region

try {
    Write-Host "Connecting to AWS..." -ForegroundColor Cyan
    $instances = (Get-EC2Instance -ErrorAction Stop).Instances
    Write-Host "Success! Found $($instances.Count) instances." -ForegroundColor Green
}
catch {
    Write-Host "ERROR: $($_.Exception.Message)" -ForegroundColor Red
    if ($_.Exception.Message -like "*Expired*") {
        Write-Host "ACTION REQUIRED: Run 'aws sso login' or refresh your Access Keys." -ForegroundColor Yellow
    }
    return
}

# Time settings for 90-day report
$endTime = Get-Date
$startTime = $endTime.AddDays(-90)
$Period = 21600 # 6-hour chunks

$report = foreach ($ins in $instances) {
    $id = $ins.InstanceId
    $name = ($ins.Tags | Where-Object { $_.Key -eq "Name" }).Value ?? "Unnamed"

    # CPU/Mem Metrics
    $cpu = Get-CWMetricStatistic -Namespace "AWS/EC2" -MetricName "CPUUtilization" -Dimension @{Name="InstanceId"; Value=$id} -StartTime $startTime -EndTime $endTime -Period $Period -Statistics Average | Select-Object -ExpandProperty Datapoints | Measure-Object -Property Average -Average
    $mem = Get-CWMetricStatistic -Namespace "CWAgent" -MetricName "Memory % Committed Bytes In Use" -Dimension @{Name="InstanceId"; Value=$id} -StartTime $startTime -EndTime $endTime -Period $Period -Statistics Average | Select-Object -ExpandProperty Datapoints | Measure-Object -Property Average -Average

    foreach ($blk in $ins.BlockDeviceMappings) {
        $vol = Get-EC2Volume -VolumeId $blk.Ebs.VolumeId
        $disk = Get-CWMetricStatistic -Namespace "CWAgent" -MetricName "LogicalDisk % Free Space" -Dimension @{Name="InstanceId"; Value=$id}, @{Name="instance"; Value="C:"} -StartTime $startTime -EndTime $endTime -Period $Period -Statistics Average | Select-Object -ExpandProperty Datapoints | Sort-Object Timestamp -Descending | Select-Object -First 1

        [PSCustomObject]@{
            Instance_Name = $name
            Instance_ID   = $id
            Vol_ID        = $blk.Ebs.VolumeId
            Size_GB       = $vol.Size
            Type          = $vol.VolumeType
            State         = $vol.State
            IsRoot        = ($ins.RootDeviceName -eq $blk.DeviceName)
            Avg_CPU_90d   = if ($cpu.Count -gt 0) { "{0:N2}%" -f $cpu.Average } else { "N/A" }
            Avg_Mem_90d   = if ($mem.Count -gt 0) { "{0:N2}%" -f $mem.Average } else { "No Agent" }
            Disk_Used_Pct = if ($disk) { "{0:N2}%" -f (100 - $disk.Average) } else { "No Agent" }
        }
    }
}

# Save to current directory
$filePath = Join-Path -Path (Get-Location) -ChildPath "AWS_90Day_Inventory.csv"
$report | Export-Csv -Path $filePath -NoTypeInformation -Encoding utf8
Write-Host "File saved: $filePath" -ForegroundColor Green
