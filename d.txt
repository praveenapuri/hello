[Amazon.AWSConfigs]::CorrectForClockSkew = $true
Set-DefaultAWSRegion -Region "us-east-1" 

$endTime = Get-Date
$startTime = $endTime.AddDays(-90)
$Period = 21600 # 6-hour chunks

$instances = (Get-EC2Instance).Instances
$report = foreach ($ins in $instances) {
    $id = $ins.InstanceId
    $name = ($ins.Tags | Where-Object { $_.Key -eq "Name" }).Value ?? "Unnamed"

    # --- Memory (Using the 'objectname' dimension you discovered) ---
    $memData = Get-CWMetricStatistic -Namespace "CWAgent" -MetricName "Memory % Committed Bytes In Use" `
        -Dimension @{Name="InstanceId"; Value=$id}, @{Name="objectname"; Value="Memory"} `
        -StartTime $startTime -EndTime $endTime -Period $Period -Statistics Average
    
    $memAvg = if ($memData.Datapoints) { 
        "{0:N2}%" -f ($memData.Datapoints | Measure-Object -Property Average -Average).Average 
    } else { "No ID Linked" }

    # --- Disk (Using common Windows dimensions) ---
    $diskData = Get-CWMetricStatistic -Namespace "CWAgent" -MetricName "LogicalDisk % Free Space" `
        -Dimension @{Name="InstanceId"; Value=$id}, @{Name="objectname"; Value="LogicalDisk"}, @{Name="instance"; Value="C:"} `
        -StartTime $startTime -EndTime $endTime -Period $Period -Statistics Average
    
    $diskVal = if ($diskData.Datapoints) {
        $free = ($diskData.Datapoints | Sort-Object Timestamp -Descending | Select-Object -First 1).Average
        "{0:N2}%" -f (100 - $free)
    } else { "No ID Linked" }

    [PSCustomObject]@{
        EC2_Name      = $name
        EC2_ID        = $id
        Avg_CPU_90d   = (Get-CWMetricStatistic -Namespace "AWS/EC2" -MetricName "CPUUtilization" -Dimension @{Name="InstanceId"; Value=$id} -StartTime $startTime -EndTime $endTime -Period $Period -Statistics Average).Datapoints.Average
        Avg_Mem_90d   = $memAvg
        Disk_Used_Pct = $diskVal
    }
}

$report | Export-Csv -Path ".\Final_Windows_Performance.csv" -NoTypeInformation
Write-Host "Report Saved to Current Directory." -ForegroundColor Green
