# main.tf

# 1. Find all EC2 instances with a specific tag
data "aws_instances" "monitored_instances" {
  filter {
    name   = "instance-state-name"
    values = ["running", "pending"]
  }

  filter {
    name   = "tag:Monitoring"
    values = ["enabled"]
  }
}

# 2. For each instance found, get its full details (including Name tag)
data "aws_instance" "instance_details" {
  for_each    = toset(data.aws_instances.monitored_instances.ids)
  instance_id = each.key
}

# 3. Dynamically build the complex metrics array for the gauge widget
locals {
  dynamic_metrics = flatten([
    for instance in values(data.aws_instance.instance_details) : [
      # For each instance, create a set of three metrics (CPU, Memory, Disk)
      # The label is created dynamically from the instance's Name tag
      ["AWS/EC2", "CPUUtilization", "InstanceId", instance.id, { region = provider.aws.region, label = "${coalesce(instance.tags.Name, instance.id)}_%CPU-UTIL" }],
      ["CWAgent", "mem_used_percent", "InstanceId", instance.id, { region = provider.aws.region, label = "${coalesce(instance.tags.Name, instance.id)}_%MEM-UTIL" }],
      [".", "disk_used_percent", ".", ".", { region = provider.aws.region, label = "${coalesce(instance.tags.Name, instance.id)}_%DISK-UTIL" }]
    ]
  ])
}


# 4. Create the CloudWatch Dashboard with the dynamically generated widget
resource "aws_cloudwatch_dashboard" "multi_metric_gauge" {
  dashboard_name = "Dynamic-Multi-Metric-Gauge"

  dashboard_body = jsonencode({
    widgets = [
      {
        type   = "metric"
        x      = 0
        y      = 0
        width  = 24
        height = 8
        properties = {
          # Use the dynamically generated list of metrics
          metrics  = local.dynamic_metrics,
          view     = "gauge",
          region   = "us-east-1",
          liveData = true,
          period   = 300,
          title    = "EC2-Health (All Monitored Instances)",
          stat     = "Average",
          yAxis = {
            left = {
              min = 0,
              max = 100
            }
          }
        }
      }
    ]
  })
}
