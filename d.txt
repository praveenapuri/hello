# 1. Global Fixes
[Amazon.AWSConfigs]::CorrectForClockSkew = $true
Set-DefaultAWSRegion -Region "us-east-1" # <--- Update if needed

$endTime = Get-Date
$startTime = $endTime.AddDays(-90)
$Period = 21600 # 6-hour chunks for 90-day stability

Write-Host "Starting report generation..." -ForegroundColor Cyan

# 2. Gather Data
$instances = (Get-EC2Instance).Instances
$report = foreach ($ins in $instances) {
    $instanceId = $ins.InstanceId
    $instanceName = ($ins.Tags | Where-Object { $_.Key -eq "Name" }).Value ?? "Unnamed"

    # Metrics
    $cpu = Get-CWMetricStatistic -Namespace "AWS/EC2" -MetricName "CPUUtilization" `
        -Dimension @{Name="InstanceId"; Value=$instanceId} -StartTime $startTime -EndTime $endTime `
        -Period $Period -Statistics Average | Select-Object -ExpandProperty Datapoints | Measure-Object -Property Average -Average
    
    $mem = Get-CWMetricStatistic -Namespace "CWAgent" -MetricName "Memory % Committed Bytes In Use" `
        -Dimension @{Name="InstanceId"; Value=$instanceId} -StartTime $startTime -EndTime $endTime `
        -Period $Period -Statistics Average | Select-Object -ExpandProperty Datapoints | Measure-Object -Property Average -Average

    foreach ($blk in $ins.BlockDeviceMappings) {
        $vol = Get-EC2Volume -VolumeId $blk.Ebs.VolumeId
        $disk = Get-CWMetricStatistic -Namespace "CWAgent" -MetricName "LogicalDisk % Free Space" `
            -Dimension @{Name="InstanceId"; Value=$instanceId}, @{Name="instance"; Value="C:"} `
            -StartTime $startTime -EndTime $endTime -Period $Period -Statistics Average | 
            Select-Object -ExpandProperty Datapoints | Sort-Object Timestamp -Descending | Select-Object -First 1

        [PSCustomObject]@{
            EC2_Name      = $instanceName
            EC2_ID        = $instanceId
            Vol_ID        = $blk.Ebs.VolumeId
            Size_GB       = $vol.Size
            Type          = $vol.VolumeType
            State         = $vol.State
            IsRoot        = ($ins.RootDeviceName -eq $blk.DeviceName)
            Avg_CPU_90d   = if ($cpu.Count -gt 0) { "{0:N2}%" -f $cpu.Average } else { "N/A" }
            Avg_Mem_90d   = if ($mem.Count -gt 0) { "{0:N2}%" -f $mem.Average } else { "No Agent" }
            Disk_Used_Pct = if ($disk) { "{0:N2}%" -f (100 - $disk.Average) } else { "No Agent" }
        }
    }
}

# 3. Export to current directory
$filePath = Join-Path -Path (Get-Location) -ChildPath "AWS_90Day_Report.csv"
$report | Export-Csv -Path $filePath -NoTypeInformation -Encoding utf8

Write-Host "Done! File saved to: $filePath" -ForegroundColor Green
