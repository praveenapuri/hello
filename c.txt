[Amazon.AWSConfigs]::CorrectForClockSkew = $true
Set-DefaultAWSRegion -Region "us-east-1"

$reservations = Get-EC2Instance
$report = foreach ($res in $reservations) {
    foreach ($ins in $res.Instances) {
        $instanceId = $ins.InstanceId
        $instanceName = ($ins.Tags | Where-Object { $_.Key -eq "Name" }).Value ?? "Unnamed"

        foreach ($blk in $ins.BlockDeviceMappings) {
            $vol = Get-EC2Volume -VolumeId $blk.Ebs.VolumeId
            $volName = ($vol.Tags | Where-Object { $_.Key -eq "Name" }).Value ?? "No Vol Name"

            [PSCustomObject]@{
                EC2_Name    = $instanceName
                EC2_ID      = $instanceId
                Vol_Name    = $volName
                Vol_ID      = $vol.VolumeId
                Size_GB     = $vol.Size
                Type        = $vol.VolumeType
                State       = $vol.State
                IsRoot      = ($ins.RootDeviceName -eq $blk.DeviceName)
            }
        }
    }
}

$report | Format-Table -AutoSize
Write-Host "Total Instances: $($reservations.Instances.Count)" -ForegroundColor Green
