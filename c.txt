{
  "schemaVersion": "2.2",
  "description": "A composite document for updating and configuring the CloudWatch agent with specific disk and memory metrics.",
  "mainSteps": [
    {
      "inputs": {
        "runCommand": [
          "sleep 1800"
        ]
      },
      "name": "first",
      "action": "aws:runShellScript",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Linux"
        ]
      }
    },
    {
      "inputs": {
        "runCommand": [
          "Start-Sleep -Seconds 1800"
        ]
      },
      "name": "second",
      "action": "aws:runPowerShellScript",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Windows"
        ]
      }
    },
    {
      "inputs": {
        "documentParameters": "{\"action\":\"Install\",\"name\" : \"AmazonCloudWatchAgent\"}",
        "documentType": "SSMDocument",
        "documentPath": "AWS-ConfigureAWSPackage"
      },
      "name": "installCWAgent",
      "action": "aws:runDocument"
    },
    {
      "inputs": {
        "runCommand": [
          "$CWConfig = '{\"metrics\":{\"append_dimensions\":{\"InstanceId\":\"${aws:InstanceId}\"},\"metrics_collected\":{\"LogicalDisk\":{\"measurement\":[\"% Free Space\"],\"resources\":[\"*\"]},\"Memory\":{\"measurement\":[\"% Committed Bytes In Use\"]}}}}'",
          "$ConfigPath = if ($IsWindows) { \"$env:ProgramFiles\\Amazon\\AmazonCloudWatchAgent\\config.json\" } else { \"/opt/aws/amazon-cloudwatch-agent/bin/config.json\" }",
          "$CWConfig | Out-File -FilePath $ConfigPath -Encoding utf8",
          "& \"$env:ProgramFiles\\Amazon\\AmazonCloudWatchAgent\\amazon-cloudwatch-agent-ctl.ps1\" -a append-config -m ec2 -c file:$ConfigPath -s"
        ]
      },
      "name": "configureCWAgent",
      "action": "aws:runPowerShellScript",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Windows"
        ]
      }
    }
  ]
}
