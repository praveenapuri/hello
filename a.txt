[Amazon.AWSConfigs]::CorrectForClockSkew = $true
Set-DefaultAWSRegion -Region "us-east-1"

$endTime = Get-Date
$startTime = $endTime.AddDays(-90)
$Period = 21600 

$instances = (Get-EC2Instance).Instances
$report = foreach ($ins in $instances) {
    $instanceId = $ins.InstanceId
    $instanceName = ($ins.Tags | Where-Object { $_.Key -eq "Name" }).Value ?? "Unnamed"
    # Get the private DNS name which usually matches the 'host' dimension in CW
    $hostName = $ins.PrivateDnsName.Split('.')[0] 

    # --- Memory ---
    $memStats = Get-CWMetricStatistic -Namespace "CWAgent" -MetricName "Memory % Committed Bytes In Use" `
        -Dimension @{Name="InstanceId"; Value=$instanceId} -StartTime $startTime -EndTime $endTime `
        -Period $Period -Statistics Average | Select-Object -ExpandProperty Datapoints | Measure-Object -Property Average -Average
    $memVal = if ($memStats.Count -gt 0) { "{0:N2}%" -f $memStats.Average } else { "No Agent" }

    # --- Disk (Searching by Hostname instead of ID) ---
    $diskStats = Get-CWMetricStatistic -Namespace "CWAgent" -MetricName "LogicalDisk % Free Space" `
        -Dimension @{Name="host"; Value=$hostName} -StartTime $startTime -EndTime $endTime `
        -Period $Period -Statistics Average | Select-Object -ExpandProperty Datapoints | Sort-Object Timestamp -Descending | Select-Object -First 1
    
    $diskVal = if ($diskStats) { 
        $used = 100 - $diskStats.Average
        "{0:N2}%" -f $used 
    } else { "No ID Link" }

    [PSCustomObject]@{
        EC2_Name      = $instanceName
        EC2_ID        = $instanceId
        Avg_Mem_90d   = $memVal
        Disk_Used_Pct = $diskVal
    }
}

$report | Format-Table -AutoSize
