# 1. Force the correct Region (CHANGE THIS to your region)
$MyRegion = "us-east-1" 
Set-DefaultAWSRegion -Region $MyRegion

# 2. Get the instances
$reservations = Get-EC2Instance
if ($null -eq $reservations -or $reservations.Count -eq 0) {
    Write-Error "No instances found in $MyRegion. Check your Region or AWS Credentials."
    return
}

# 3. Build the report
$report = foreach ($res in $reservations) {
    foreach ($ins in $res.Instances) {
        $name = ($ins.Tags | Where-Object { $_.Key -eq "Name" }).Value
        
        foreach ($blk in $ins.BlockDeviceMappings) {
            $vol = Get-EC2Volume -VolumeId $blk.Ebs.VolumeId
            
            [PSCustomObject]@{
                InstanceName = $name
                InstanceId   = $ins.InstanceId
                VolumeId     = $vol.VolumeId
                Size_GB      = $vol.Size
                Type         = $vol.VolumeType
                IsRoot       = ($ins.RootDeviceName -eq $blk.DeviceName)
                State        = $vol.State
            }
        }
    }
}

# 4. Display the result
$report | Format-Table -AutoSize
