# 1. Define the updated Config (Ensures InstanceId is appended)
$JSONConfig = @'
{
    "metrics": {
        "append_dimensions": {
            "InstanceId": "${aws:InstanceId}"
        },
        "metrics_collected": {
            "LogicalDisk": {
                "measurement": ["% Free Space"],
                "resources": ["*"]
            },
            "Memory": {
                "measurement": ["% Committed Bytes In Use"]
            }
        }
    }
}
'@

# 2. Send the command to all Windows Instances
# This installs/updates the config and restarts the agent
Send-SSMCommand -DocumentName "AmazonCloudWatch-ManageAgent" `
    -Parameter @{
        "action" = "configure"
        "mode"   = "ec2"
        "optionalConfigurationSource" = "online"
        "optionalConfigurationLocation" = $JSONConfig
        "optionalRestart" = "yes"
    } `
    -Target @{ Key="tag:Platform"; Values="Windows" } # Or use Key="InstanceIds"; Values="*"
