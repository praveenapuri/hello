terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = "us-east-1" # <-- Change to your desired region
}

# Data source to find all instances that aren't terminated
data "aws_instances" "all" {
  instance_state_names = ["pending", "running", "shutting-down", "stopping", "stopped"]
}

# Output a simple list of the instance IDs found
output "instance_ids" {
  description = "A list of all instance IDs found."
  value       = data.aws_instances.all.ids
}

# Output a map of each instance ID to its current state
output "instance_statuses" {
  description = "A map of instance IDs to their current status."
  value = {
    for id in data.aws_instances.all.ids : id => data.aws_instance.all[id].instance_state
  }
}

# Data source to get details for each individual instance found above
# This is needed to access the 'instance_state' for each one
data "aws_instance" "all" {
  for_each = toset(data.aws_instances.all.ids)
  instance_id = each.key
}
