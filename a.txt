# Get all running and stopped instances
$instances = Get-EC2Instance

$report = foreach ($reservation in $instances) {
    foreach ($instance in $reservation.Instances) {
        $instanceId = $instance.InstanceId
        $instanceName = ($instance.Tags | Where-Object { $_.Key -eq "Name" }).Value
        $rootDeviceName = $instance.RootDeviceName

        foreach ($mapping in $instance.BlockDeviceMappings) {
            $volId = $mapping.Ebs.VolumeId
            $devName = $mapping.DeviceName
            
            # Fetch specific volume details (Type, Size)
            $volDetail = Get-EC2Volume -VolumeId $volId
            $volNameTag = ($volDetail.Tags | Where-Object { $_.Key -eq "Name" }).Value

            [PSCustomObject]@{
                InstanceName = $instanceName
                InstanceId   = $instanceId
                VolumeId     = $volId
                NameTag      = $volNameTag
                Device       = $devName
                Type         = $volDetail.VolumeType
                Size_GiB     = $volDetail.Size
                IsRoot       = ($devName -eq $rootDeviceName)
                Utilization  = "Requires CloudWatch Agent"
            }
        }
    }
}

# Display in a nice table
$report | Format-Table -AutoSize
