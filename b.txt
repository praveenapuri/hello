  # --- Robust OS detection: platform, platform_details, or OS tag fallback ---
  local_all_instance_ids = toset([
    for inst in values(data.aws_instance.instance_details) : inst.id
  ])

  local_windows_ids = toset([
    for inst in values(data.aws_instance.instance_details) : inst.id
    if (
      lower(try(inst.platform, "")) == "windows"                                     # explicit platform
      || contains(lower(try(inst.platform_details, "")), "windows")                  # platform_details says Windows
      || lower(try(inst.tags.OS, "")) == "windows"                                   # tag fallback: OS=Windows
      || lower(try(inst.tags.Os, "")) == "windows"                                   # common variant
      || lower(try(inst.tags.os, "")) == "windows"
    )
  ])

  local_linux_ids = setsubtract(local_all_instance_ids, local_windows_ids)


  linux_ids   = local.local_linux_ids
  windows_ids = local.local_windows_ids
