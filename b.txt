# main.tf
terraform {
  backend "s3" {}
}

resource "aws_cloudwatch_dashboard" "ec2_explorer_dashboard" {
  dashboard_name = "EC2-Explorer-Dashboard"

  dashboard_body = jsonencode({
    widgets = [
      # Widget 1: CPU Utilization Explorer
      {
        type   = "explorer",
        x      = 0,
        y      = 0,
        width  = 24,
        height = 6,
        properties = {
          title = "CPU Utilization (All Monitored Instances)",
          # This search expression finds all instances with the specified tag
          metrics = [
            {
              "expression" : "SEARCH('{AWS/EC2,InstanceId} MetricName=\"CPUUtilization\" tag:Monitoring=enabled', 'Average', 300)"
            }
          ]
        }
      },
      # Widget 2: Memory Utilization Explorer
      {
        type   = "explorer",
        x      = 0,
        y      = 6, # Positioned below the CPU widget
        width  = 24,
        height = 6,
        properties = {
          title = "Memory Utilization (All Monitored Instances)",
          metrics = [
            {
              "expression" : "SEARCH('{CWAgent,InstanceId} MetricName=\"mem_used_percent\" tag:Monitoring=enabled', 'Average', 300)"
            }
          ]
        }
      },
      # Widget 3: Disk Utilization Explorer
      {
        type   = "explorer",
        x      = 0,
        y      = 12, # Positioned below the Memory widget
        width  = 24,
        height = 6,
        properties = {
          title = "Disk Utilization (All Monitored Instances)",
          metrics = [
            {
              "expression" : "SEARCH('{CWAgent,InstanceId,device,fstype,path} MetricName=\"disk_used_percent\" tag:Monitoring=enabled', 'Average', 300)"
            }
          ]
        }
      }
    ]
  })
}
