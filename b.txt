# main.tf
terraform {
  backend "s3" {}
}

data "aws_instances" "monitored_instances" {
  filter {
    name   = "instance-state-name"
    values = ["running", "pending"]
  }

  filter {
    name   = "tag:Monitoring"
    values = ["enabled"]
  }
}

data "aws_instance" "instance_details" {
  for_each    = toset(data.aws_instances.monitored_instances.ids)
  instance_id = each.key
}

locals {
  # Define constants for widget layout
  widget_width      = 6
  widget_height     = 5
  widgets_in_a_row  = 4 # 24 (dashboard width) / 6 (widget width)

  # A list of all the individual metric widgets
  metric_widgets = flatten([
    for instance in values(data.aws_instance.instance_details) : [
      # CPU Widget
      {
        type = "metric",
        properties = {
          view    = "singleValue",
          title   = "CPU - ${coalesce(instance.tags.Name, instance.id)}",
          metrics = [["AWS/EC2", "CPUUtilization", "InstanceId", instance.id]],
          region  = provider.aws.region,
          min     = 0,
          max     = 100
        }
      },
      # Memory Widget
      {
        type = "metric",
        properties = {
          view    = "singleValue",
          title   = "Memory - ${coalesce(instance.tags.Name, instance.id)}",
          metrics = [["CWAgent", "mem_used_percent", "InstanceId", instance.id]],
          region  = provider.aws.region,
          min     = 0,
          max     = 100
        }
      },
      # Disk Widget
      {
        type = "metric",
        properties = {
          view    = "singleValue",
          title   = "Disk - ${coalesce(instance.tags.Name, instance.id)}",
          metrics = [["CWAgent", "disk_used_percent", "InstanceId", instance.id, "device", "nvme0n1p1", "fstype", "xfs", "path", "/"]],
          region  = provider.aws.region,
          min     = 0,
          max     = 100
        }
      }
    ]
  ])

  # Final list of all widgets, including the title and calculated positions
  all_widgets = concat(
    # 1. The Title Widget for the Group
    [
      {
        type   = "text",
        x      = 0,
        y      = 0,
        width  = 24,
        height = 1,
        properties = {
          markdown = "## EC2 Instance Health"
        }
      }
    ],
    # 2. All Metric Widgets with calculated positions
    [
      for index, widget in local.metric_widgets : {
        type   = widget.type,
        x      = (index % local.widgets_in_a_row) * local.widget_width,
        y      = floor(index / local.widgets_in_a_row) * local.widget_height + 1, # +1 to place below title
        width  = local.widget_width,
        height = local.widget_height,
        properties = widget.properties
      }
    ]
  )
}

resource "aws_cloudwatch_dashboard" "ec2_consolidated" {
  dashboard_name = "EC2-Health-Consolidated"
  dashboard_body = jsonencode({
    widgets = local.all_widgets
  })
}
