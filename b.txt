  # --- Robust OS detection: platform, platform_details, or OS tag fallback ---
  all_instance_ids = toset([
    for inst in values(data.aws_instance.instance_details) : inst.id
  ])

  windows_ids = toset([
    for inst in values(data.aws_instance.instance_details) : inst.id
    if (
      lower(try(inst.platform, "")) == "windows"                                      # explicit platform
      || length(regexall("windows", lower(try(inst.platform_details, "")))) > 0       # match in platform_details
      || lower(try(inst.tags.OS, "")) == "windows"                                    # tag fallback: OS=Windows
      || lower(try(inst.tags.Os, "")) == "windows"
      || lower(try(inst.tags.os, "")) == "windows"
    )
  ])

  linux_ids = setsubtract(local.all_instance_ids, local.windows_ids)
