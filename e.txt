# This JSON adds the InstanceId dimension to your Windows metrics
$CWConfig = @'
{
    "metrics": {
        "append_dimensions": {
            "InstanceId": "${aws:InstanceId}"
        },
        "metrics_collected": {
            "LogicalDisk": {
                "measurement": ["% Free Space"],
                "resources": ["*"],
                "append_dimensions": { "InstanceId": "${aws:InstanceId}" }
            },
            "Memory": {
                "measurement": ["% Committed Bytes In Use"],
                "append_dimensions": { "InstanceId": "${aws:InstanceId}" }
            }
        }
    }
}
'@

# Push this config to all Windows instances via SSM
Send-SSMCommand -DocumentName "AmazonCloudWatch-ManageAgent" `
    -Parameter @{
        "action" = "configure"
        "mode"   = "ec2"
        "optionalConfigurationSource" = "online"
        "optionalConfigurationLocation" = $CWConfig
        "optionalRestart" = "yes"
    } `
    -Target @{ Key="tag:Platform"; Values="Windows" }
