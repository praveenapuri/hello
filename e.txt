# 1. Ensure the module is loaded
Import-Module AWS.Tools.SimpleSystemsManagement

# 2. Define the JSON as a single-line string to avoid parsing errors
$CWConfig = '{"metrics":{"append_dimensions":{"InstanceId":"${aws:InstanceId}"},"metrics_collected":{"LogicalDisk":{"measurement":["% Free Space"],"resources":["*"]},"Memory":{"measurement":["% Committed Bytes In Use"]}}}}'

# 3. Use explicit parameter keys
$params = @{
    "action"                        = "configure"
    "mode"                          = "ec2"
    "optionalConfigurationSource"   = "online"
    "optionalConfigurationLocation" = $CWConfig
    "optionalRestart"               = "yes"
}

# 4. Target your instances (Adjust the Tag key/value to match your environment)
Send-SSMCommand -DocumentName "AmazonCloudWatch-ManageAgent" `
    -Parameter $params `
    -Target @{ Key="tag:OS"; Values="Windows" } # <--- Change 'tag:OS' to 'tag:Name' or use InstanceIds if needed
