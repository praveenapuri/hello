# 1. Configuration
$Region = "us-east-1"  # <--- Change to your region
Set-DefaultAWSRegion -Region $Region

$endTime = Get-Date
$startTime = $endTime.AddDays(-90)

# 7200 seconds (2 hours) ensures we get ~1080 datapoints for 90 days, staying under the 1440 limit.
$Period = 7200 

# 2. Fetch Instances
$reservations = Get-EC2Instance
$instanceList = $reservations.Instances

$report = foreach ($ins in $instanceList) {
    $instanceId = $ins.InstanceId
    $instanceName = ($ins.Tags | Where-Object { $_.Key -eq "Name" }).Value ?? "Unnamed"

    # --- Avg CPU Utilization (90 Days) ---
    $cpuStats = Get-CWMetricStatistic -Namespace "AWS/EC2" `
        -MetricName "CPUUtilization" `
        -Dimension @{Name="InstanceId"; Value=$instanceId} `
        -StartTime $startTime -EndTime $endTime -Period $Period -Statistics Average | 
        Select-Object -ExpandProperty Datapoints | Measure-Object -Property Average -Average
    
    $cpuAvg = if ($cpuStats.Count -gt 0) { "{0:N2}%" -f $cpuStats.Average } else { "No Data" }

    # --- Avg Memory Utilization (90 Days) ---
    # Windows default metric name: "Memory % Committed Bytes In Use"
    $memStats = Get-CWMetricStatistic -Namespace "CWAgent" `
        -MetricName "Memory % Committed Bytes In Use" `
        -Dimension @{Name="InstanceId"; Value=$instanceId} `
        -StartTime $startTime -EndTime $endTime -Period $Period -Statistics Average | 
        Select-Object -ExpandProperty Datapoints | Measure-Object -Property Average -Average

    $memAvg = if ($memStats.Count -gt 0) { "{0:N2}%" -f $memStats.Average } else { "No Agent" }

    [PSCustomObject]@{
        EC2_Name      = $instanceName
        EC2_ID        = $instanceId
        Avg_CPU_90d   = $cpuAvg
        Avg_Mem_90d   = $memAvg
    }
}

# 3. Output Results
Write-Host "`n--- EC2 Usage Report (Last 90 Days) ---" -ForegroundColor Cyan
$report | Format-Table -AutoSize

Write-Host "Total Number of EC2 Instances: $($instanceList.Count)" -ForegroundColor Yellow
