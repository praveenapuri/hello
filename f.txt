resource "aws_cloudwatch_metric_alarm" "linux_instance_disk_high" {
  # Only create alarms in TEST / PROD
  for_each = var.Environment == "TEST" || var.Environment == "PROD"
    ? { for id, inst in data.aws_instance.instance_details : id => inst if inst.platform != "windows" }
    : {}

  alarm_name        = "linux_high_disk_usage_${each.key}"
  alarm_description = "${var.env} | CRITICAL | Epic Payer Platform | Linux Disk Usage High >= 80% on ${lookup(each.value.tags, "Name", each.key)}"
  alarm_actions     = [local.us_east_1_alarm_funnel]

  namespace           = "CWAgent"
  metric_name         = "disk_used_percent"
  statistic           = "Average"
  period              = 300
  evaluation_periods  = 1
  threshold           = 80
  comparison_operator = "GreaterThanOrEqualToThreshold"
  treat_missing_data  = "notBreaching"
  actions_enabled     = true

  # Root filesystem; change path if you care about a different mount
  dimensions = {
    InstanceId = each.key
    path       = "/"
  }

  tags = merge(local.tags, local.cigna_tags)
}


resource "aws_cloudwatch_metric_alarm" "linux_instance_memory_high" {
  # Only create alarms in TEST / PROD
  for_each = var.Environment == "TEST" || var.Environment == "PROD"
    ? { for id, inst in data.aws_instance.instance_details : id => inst if inst.platform != "windows" }
    : {}

  alarm_name        = "linux_high_memory_usage_${each.key}"
  alarm_description = "${var.env} | CRITICAL | Epic Payer Platform | Linux Memory Usage High >= 80% on ${lookup(each.value.tags, "Name", each.key)}"
  alarm_actions     = [local.us_east_1_alarm_funnel]

  namespace           = "CWAgent"
  metric_name         = "mem_used_percent"
  statistic           = "Average"
  period              = 300
  evaluation_periods  = 1
  threshold           = 80
  comparison_operator = "GreaterThanOrEqualToThreshold"
  treat_missing_data  = "notBreaching"
  actions_enabled     = true

  dimensions = {
    InstanceId = each.key
  }

  tags = merge(local.tags, local.cigna_tags)
}
